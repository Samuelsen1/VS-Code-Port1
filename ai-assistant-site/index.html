<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>General</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400;1,9..40,500&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f8fafc;
      --bg-gradient: linear-gradient(180deg, #fafbff 0%, #f1f5f9 100%);
      --surface: #ffffff;
      --border: #e2e8f0;
      --border-soft: #f1f5f9;
      --text: #0f172a;
      --text-soft: #334155;
      --text-dim: #64748b;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --accent-soft: rgba(37, 99, 235, 0.1);
      --accent-soft-2: rgba(37, 99, 235, 0.06);
      --user-bg: #ffffff;
      --user-border: rgba(37, 99, 235, 0.2);
      --ai-bg: #ffffff;
      --radius: 14px;
      --radius-sm: 10px;
      --shadow: 0 1px 2px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
      --font: "DM Sans", -apple-system, BlinkMacSystemFont, sans-serif;
      --mono: "JetBrains Mono", "SF Mono", "Consolas", monospace;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; min-height: 100%; background: var(--bg); background-image: var(--bg-gradient); color: var(--text); font-family: var(--font); font-size: 15px; line-height: 1.6; -webkit-font-smoothing: antialiased; font-weight: 500; overflow: hidden; }
    .app-wrap { display: flex; flex-direction: row; height: 100vh; min-height: 100vh; overflow: hidden; }
    .history-rail { width: 48px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; padding-top: 1rem; background: var(--surface); border-right: 1px solid var(--border); position: relative; z-index: 60; }
    .sidebar { position: fixed; left: 48px; top: 0; bottom: 0; width: 280px; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 50; transform: translateX(-100%); transition: transform 0.2s; box-shadow: 4px 0 20px rgba(0,0,0,0.08); }
    .sidebar.open { transform: translateX(0); }
    .sidebar-header { flex-shrink: 0; padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); }
    .sidebar-header .logo { font-weight: 700; font-size: 1.05rem; color: var(--text); display: flex; align-items: center; gap: 0.4rem; }
    .sidebar-header .logo-icon { color: var(--accent); width: 1.25em; height: 1.25em; object-fit: contain; display: inline-block; vertical-align: middle; }
    .sidebar-title { flex-shrink: 0; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-dim); margin: 1rem 1.25rem 0.5rem; }
    .sidebar-list { flex: 1; min-height: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 0 0.75rem 0.75rem; }
    .sidebar-list li { list-style: none; margin: 0 0 0.25rem; padding: 0.5rem 0.65rem; border-radius: var(--radius-sm); cursor: pointer; font-size: 0.8rem; color: var(--text-soft); line-height: 1.35; }
    .sidebar-list li:hover { background: var(--accent-soft-2); color: var(--accent); }
    .sidebar-list li.you { border-left: 2px solid transparent; }
    .sidebar-list li.general { border-left: 2px solid var(--accent-soft); padding-left: 0.5rem; }
    .sidebar-empty { padding: 1rem 1.25rem; font-size: 0.8rem; color: var(--text-dim); }
    .sidebar-footer { flex-shrink: 0; padding: 0.75rem 1rem; border-top: 1px solid var(--border); }
    .sidebar-footer .new-chat { width: 100%; padding: 0.6rem 1rem; min-height: 44px; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-sm); font: inherit; font-size: 0.85rem; font-weight: 500; color: var(--text-soft); cursor: pointer; transition: background 0.2s, color 0.2s, border-color 0.2s; touch-action: manipulation; }
    .sidebar-footer .new-chat:hover { background: var(--accent-soft-2); color: var(--accent); border-color: var(--accent); }
    .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.2); z-index: 40; }
    .sidebar-overlay.visible { display: block; }
    .history-btn { display: flex; align-items: center; justify-content: center; width: 44px; height: 44px; padding: 0; background: none; border: none; border-radius: var(--radius-sm); color: var(--text-dim); cursor: pointer; touch-action: manipulation; flex-shrink: 0; }
    .history-btn:hover { background: var(--accent-soft-2); color: var(--accent); }
    .history-btn svg { width: 22px; height: 22px; }
    @media (max-width: 767px) {
      .history-rail { width: 44px; padding-top: 0.75rem; }
      .sidebar { left: 44px; max-width: 85vw; padding-left: env(safe-area-inset-left, 0); }
      .app { padding: 1rem 1rem calc(1.25rem + env(safe-area-inset-bottom, 0px)) 1rem; }
      .header { margin-bottom: 1rem; padding-bottom: 0.75rem; }
      .tagline { margin: 0.35rem 0 0 0; font-size: 0.8rem; }
      .message { padding: 0.9rem 1rem; max-width: 95%; }
      .message pre, .message code { font-size: 0.82em; }
      .form { padding: 0.4rem; gap: 0.5rem; }
      .form #input { font-size: 1rem; padding: 0.75rem 0.85rem; min-height: 48px; }
      .form button { padding: 0.75rem 1rem; font-size: 0.9rem; }
      .form-wrap { padding-top: 1rem; }
      .hint { font-size: 0.7rem; }
    }
    @media (max-width: 480px) {
      .app { padding: 0.75rem 0.75rem calc(1rem + env(safe-area-inset-bottom, 0px)) 0.75rem; }
      .header { margin-bottom: 0.75rem; padding-bottom: 0.6rem; }
      .message { padding: 0.75rem 0.85rem; }
      .form { padding: 0.35rem; gap: 0.4rem; }
      .form #input { padding: 0.7rem 0.75rem; }
      .form button { padding: 0.7rem 0.9rem; font-size: 0.85rem; }
    }
    .app { flex: 1; max-width: 600px; margin: 0 auto; min-height: 0; width: 100%; display: flex; flex-direction: column; padding: 1.5rem 1.25rem 1.75rem; overflow: hidden; }
    .header { flex-shrink: 0; margin-bottom: 1.5rem; padding-bottom: 1.1rem; border-bottom: 2px solid var(--border); position: relative; }
    .header::after { content: ""; position: absolute; bottom: -2px; left: 0; width: 48px; height: 2px; background: var(--accent); border-radius: 1px; }
    .header-row { display: flex; align-items: center; gap: 0.5rem; }
    .logo { display: flex; align-items: center; gap: 0.5rem; font-weight: 700; font-size: 1.15rem; color: var(--text); letter-spacing: -0.02em; }
    .logo .logo-icon { width: 1.25em; height: 1.25em; object-fit: contain; display: inline-block; vertical-align: middle; }
    .logo .logo-icon.logo-fallback { width: auto; height: auto; object-fit: none; font-size: 1.25em; color: var(--accent); }
    .tagline { margin: 0.4rem 0 0 1.5rem; font-size: 0.8rem; color: var(--text-dim); font-weight: 400; }
    .chat { flex: 1; min-height: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; display: flex; flex-direction: column; gap: 1.1rem; padding: 0.25rem 0; }
    .message { padding: 1.1rem 1.25rem; border-radius: var(--radius); max-width: 88%; box-shadow: var(--shadow); transition: box-shadow 0.2s; }
    .message:hover { box-shadow: var(--shadow-md); }
    .message .label { display: block; font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.4rem; color: var(--text-dim); }
    .message p { margin: 0; white-space: pre-wrap; word-break: break-word; color: var(--text-soft); }
    .message strong { font-weight: 700; color: var(--text); }
    .message em { font-style: italic; font-weight: 500; }
    .message code { font-family: var(--mono); font-size: 0.86em; font-weight: 400; background: var(--accent-soft); color: var(--accent); padding: 0.15em 0.4em; border-radius: 6px; }
    .message pre { margin: 0.5em 0; padding: 0.75em 1em; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-sm); overflow-x: auto; font-size: 0.86em; font-family: var(--mono); font-weight: 400; white-space: pre-wrap; }
    .message pre code { background: none; padding: 0; color: var(--text-soft); }
    .message a { color: var(--accent); text-decoration: none; font-weight: 500; border-bottom: 1px solid rgba(37,99,235,0.3); transition: border-color 0.2s, color 0.2s; }
    .message a:hover { color: var(--accent-hover); border-bottom-color: var(--accent); }
    .message .msg-heading { display: block; font-weight: 700; font-size: 1.05em; margin: 0.6em 0 0.25em; color: var(--text); }
    .message .msg-heading:first-child { margin-top: 0; }
    .message ul { margin: 0.4em 0; padding-left: 1.35em; }
    .message.user { align-self: flex-end; background: var(--user-bg); border: 1px solid var(--user-border); }
    .message.user .label { color: var(--accent); }
    .message.ai { align-self: flex-start; background: var(--ai-bg); border: 1px solid var(--border); border-left: 3px solid var(--accent); }
    .form-wrap { flex-shrink: 0; margin-top: auto; padding-top: 1.25rem; border-top: 1px solid var(--border); }
    .form { display: flex; gap: 0.6rem; align-items: flex-end; padding: 0.5rem; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); }
    .form #input { flex: 1; min-width: 0; min-height: 48px; padding: 0.85rem 1rem; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-family: var(--font); font-size: 0.95rem; transition: border-color 0.2s, box-shadow 0.2s; }
    .form #input::placeholder { color: var(--text-dim); }
    .form #input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-soft); }
    .form button { padding: 0.85rem 1.35rem; background: var(--accent); color: #fff; border: none; border-radius: var(--radius-sm); font-family: var(--font); font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: background 0.2s, transform 0.1s; touch-action: manipulation; }
    .form button:hover { background: var(--accent-hover); }
    .form button:active { transform: scale(0.98); }
    .form button:disabled { opacity: 0.6; cursor: not-allowed; }
    .attach-btn { display: flex; align-items: center; justify-content: center; width: 48px; height: 48px; min-width: 48px; min-height: 48px; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-dim); cursor: pointer; transition: color 0.2s, border-color 0.2s, background 0.2s; flex-shrink: 0; touch-action: manipulation; }
    .attach-btn:hover { color: var(--accent); border-color: var(--accent); background: var(--accent-soft-2); }
    .attach-btn svg { width: 20px; height: 20px; }
    .file-chosen { margin-top: 0.4rem; font-size: 0.75rem; color: var(--text-dim); }
    .file-chosen span { color: var(--accent); font-weight: 500; }
    .hint { margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-dim); }
    .typing { opacity: 0.85; }
    .typing .label::after { content: " …"; animation: dots 1s steps(4, end) infinite; }
    @keyframes dots { 0%, 20% { content: " …"; } 40% { content: " ."; } 60% { content: " .."; } 80%, 100% { content: " …"; } }
  </style>
</head>
<body>
  <div class="app-wrap">
    <div class="history-rail">
      <button type="button" class="history-btn" id="history-btn" aria-label="Open history">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 4h18M3 8h18M3 12h12M3 16h10"/></svg>
      </button>
    </div>
    <aside id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <div class="logo"><img src="/images/g.png" alt="General" class="logo-icon" onerror="if(!this.dataset.alt){this.dataset.alt=1;this.src='images/g.png';return}this.outerHTML='<span class=\'logo-icon logo-fallback\'>◇</span>'" /><span>General</span></div>
      </div>
      <p class="sidebar-title">Past chats</p>
      <ul id="past-chats-list" class="sidebar-list"></ul>
      <div class="sidebar-footer">
        <button type="button" id="clear-chat" class="new-chat">+ New chat</button>
      </div>
    </aside>
    <div class="sidebar-overlay" id="sidebar-overlay" aria-hidden="true"></div>
    <main class="app">
      <header class="header">
        <div class="header-row">
          <div class="logo"><img src="/images/g.png" alt="General" class="logo-icon" onerror="if(!this.dataset.alt){this.dataset.alt=1;this.src='images/g.png';return}this.outerHTML='<span class=\'logo-icon logo-fallback\'>◇</span>'" /><span>General</span></div>
        </div>
        <p class="tagline">Wikipedia, search, and AI. Short answers.</p>
      </header>
      <section class="chat" id="chat">
        <div class="message ai">
          <span class="label">General</span>
          <p>Hi. I'm General. Ask me anything — I look it up with Wikipedia, web search, weather, definitions, news, and AI.</p>
        </div>
      </section>
      <div class="form-wrap">
        <form class="form" id="form">
          <label for="file-input" class="attach-btn" aria-label="Attach image or PDF" title="Attach image or PDF">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
          </label>
          <input type="file" id="file-input" accept="image/*,.pdf" style="display:none">
          <input type="text" id="input" placeholder="Ask anything…" autocomplete="off" enterkeyhint="send" />
          <button type="submit" id="send" aria-label="Send">Send</button>
        </form>
        <p class="file-chosen" id="file-chosen" style="display:none"><span id="file-name"></span></p>
        <p class="hint">Built by Opoku Samuel</p>
      </div>
    </main>
  </div>
  <script>
    (function () {
      // Fallback when /api/chat fails (offline or not configured)
      const KNOWLEDGE = [
        { patterns: ["hi","hello","hey"], responses: ["Hi. Ask me anything."] },
        { patterns: ["who are you","what are you"], responses: ["General. Wikipedia + search + AI. Ask a question."] },
        { patterns: ["help"], responses: ["Ask a question. Set API keys in Vercel for search and AI."] },
        { patterns: [], responses: ["API not configured. Try 'help' or set keys in Vercel."] }
      ];
      function normalize(t) { return t.replace(/[^\w\s]/g, "").toLowerCase().trim(); }
      function tokenize(t) { return normalize(t).split(/\s+/).filter(Boolean); }
      function scoreMatch(userSet, patternList) { if (!patternList.length) return 0; let n = 0; for (const t of patternList) if (userSet.has(t)) n++; return n / patternList.length; }
      function thinkFallback(msg) {
        const raw = (msg || "").trim();
        if (!raw) return "Ask something.";
        const userSet = new Set(tokenize(raw));
        let best = 0, entry = null;
        for (const e of KNOWLEDGE) { if (!e.patterns.length) continue; for (const p of e.patterns) { const s = scoreMatch(userSet, tokenize(p)); if (s > best) { best = s; entry = e; } } }
        if (entry && best >= 0.3) return entry.responses[0];
        return (KNOWLEDGE.find(e => !e.patterns.length) || {}).responses?.[0] || "No API. Ask 'help'.";
      }

      const chat = document.getElementById("chat");
      const form = document.getElementById("form");
      const input = document.getElementById("input");
      const send = document.getElementById("send");
      const fileInput = document.getElementById("file-input");
      const fileChosen = document.getElementById("file-chosen");
      const fileNameEl = document.getElementById("file-name");
      const sidebar = document.getElementById("sidebar");
      const sidebarOverlay = document.getElementById("sidebar-overlay");
      const pastChatsList = document.getElementById("past-chats-list");
      let chosenFile = null;

      function closeSidebar() {
        if (sidebar) sidebar.classList.remove("open");
        if (sidebarOverlay) { sidebarOverlay.classList.remove("visible"); sidebarOverlay.setAttribute("aria-hidden", "true"); }
      }

      function renderPastChats() {
        try {
          if (!pastChatsList) return;
          pastChatsList.innerHTML = "";
          var archive = [];
          try { var r = localStorage.getItem("general_chat_archive"); if (r) { var a = JSON.parse(r); if (Array.isArray(a)) archive = a; } } catch (_) {}
          archive.slice(-5).reverse().forEach(function (entry) {
            var li = document.createElement("li");
            li.className = "general";
            var first = (entry.history && entry.history[0]) ? String(entry.history[0].content || "").trim().slice(0, 28) : "";
            li.textContent = (first || "Chat") + " · " + (entry.createdAt ? new Date(entry.createdAt).toLocaleDateString() : "");
            li.addEventListener("click", (function (session) { return function () {
              if (!session || !session.history || !Array.isArray(session.history)) return;
              history = session.history.slice(0);
              try { localStorage.setItem("general_chat_history", JSON.stringify(history)); } catch (_) {}
              var msgs = chat ? chat.querySelectorAll(".message") : [];
              for (var i = 1; i < msgs.length; i++) { try { msgs[i].remove(); } catch (_) {} }
              session.history.forEach(function (m) { if (m && (m.role === "user" || m.role === "assistant")) addMessage(m.role === "user" ? "user" : "ai", m.content || ""); });
              scheduleRenderHistory();
              closeSidebar();
            }; })(entry));
            pastChatsList.appendChild(li);
          });
        } catch (e) {}
      }

      function scheduleRenderHistory() {
        setTimeout(function () { try { renderPastChats(); } catch (e) {} }, 100);
      }

      fileInput.addEventListener("change", function() {
        chosenFile = fileInput.files?.[0] || null;
        if (chosenFile) { fileNameEl.textContent = chosenFile.name; fileChosen.style.display = ""; }
        else { fileNameEl.textContent = ""; fileChosen.style.display = "none"; }
      });

      function formatMsg(t) {
        if (!t) return "";
        let s = String(t).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        s = s.replace(/```\n?([\s\S]*?)```/g, "<pre><code>$1</code></pre>");
        s = s.replace(/`([^`]+)`/g, "<code>$1</code>");
        s = s.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
        s = s.replace(/__([^_]+)__/g, "<strong>$1</strong>");
        s = s.replace(/\*([^*]+)\*/g, "<em>$1</em>");
        s = s.replace(/_([^_]+)_/g, "<em>$1</em>");
        s = s.replace(/\[([^\]]+)\]\(([^)]+)\)/g, function (_, txt, url) { var u = /^https?:\/\//i.test(url) ? url.replace(/&/g,"&amp;").replace(/"/g,"&quot;") : "#"; return "<a href=\"" + u + "\" target=\"_blank\" rel=\"noopener\">" + txt + "</a>"; });
        s = s.replace(/^## (.+)$/gm, "<span class=\"msg-heading\">$1</span>");
        s = s.replace(/^\s*[-*]\s+(.+)$/gm, "<li>$1</li>");
        s = s.replace(/((?:<li>[\s\S]*?<\/li>\n?)+)/g, "<ul>$1</ul>");
        return s;
      }

      function addMessage(role, text, label) {
        const d = document.createElement("div");
        d.className = "message " + role;
        d.innerHTML = "<span class=\"label\">" + (label || (role === "user" ? "You" : "General")) + "</span><p></p>";
        d.querySelector("p").innerHTML = formatMsg(text);
        chat.appendChild(d);
        requestAnimationFrame(function () { d.scrollIntoView({ behavior: "auto", block: "end" }); });
      }

      /* input is type="text": Enter submits the form by default; no newlines possible */

      function addTyping() {
        const d = document.createElement("div");
        d.className = "message ai typing";
        d.innerHTML = "<span class=\"label\">General</span><p>Searching…</p>";
        chat.appendChild(d);
        requestAnimationFrame(function () { d.scrollIntoView({ behavior: "auto", block: "end" }); });
        return d;
      }

      const MAX_FILE = 3 * 1024 * 1024; // 3 MB (keeps JSON under Vercel 4.5MB)
      function toBase64(buf) {
        const u = new Uint8Array(buf);
        let s = "";
        for (let i = 0; i < u.length; i += 8192) s += String.fromCharCode.apply(null, u.subarray(i, i + 8192));
        return btoa(s);
      }

      if (form && input) form.addEventListener("submit", async function(e) {
        e.preventDefault();
        const raw = input.value.trim();
        const file = chosenFile;
        if (!raw && !file) { input.focus(); return; }
        const displayMsg = raw || (file ? "[" + file.name + "]" : "");
        if (file && file.size > MAX_FILE) {
          addMessage("user", displayMsg);
          addMessage("ai", "File too large. Use a PDF or image under 3 MB.");
          chosenFile = null; fileInput.value = ""; fileNameEl.textContent = ""; fileChosen.style.display = "none";
          return;
        }
        addMessage("user", displayMsg);
        input.value = "";
        if (file) { chosenFile = null; fileInput.value = ""; fileNameEl.textContent = ""; fileChosen.style.display = "none"; }
        send.disabled = true;
        const typingEl = addTyping();

        try {
          const body = { message: raw || (file ? "What is in this file?" : "") };
          if (file) {
            const buf = await file.arrayBuffer();
            const isPdf = (file.type || "").toLowerCase() === "application/pdf";
            if (isPdf) body.pdf = toBase64(buf); else body.image = toBase64(buf);
          }
          body.history = history.slice(-20);
          const res = await fetch("/api/chat", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body), signal: AbortSignal.timeout(60000) });
          let data;
          try { data = await res.json(); } catch (_) { data = { reply: "Request failed (" + (res ? res.status : "?") + "). " + (res && res.status === 413 ? "File too large. Use under 3 MB." : "Check /api/chat and DEEPSEEK_API_KEY in Vercel.") }; }
          const reply = (data && data.reply) ? data.reply : (data && data.error) ? data.error : (!res || !res.ok) ? ("Request failed (" + (res ? res.status : "?") + "). Check /api/chat and DEEPSEEK_API_KEY in Vercel.") : "No reply.";
          typingEl.classList.remove("typing");
          typingEl.querySelector("p").innerHTML = formatMsg(reply);
          history.push({ role: "user", content: body.message });
          history.push({ role: "assistant", content: reply });
          try { localStorage.setItem("general_chat_history", JSON.stringify(history.slice(-20))); } catch (_) {}
          requestAnimationFrame(function () { typingEl.scrollIntoView({ behavior: "auto", block: "end" }); });
          scheduleRenderHistory();
        } catch (err) {
          var errMsg = (err && err.name === "AbortError") ? "Request timed out. Check your connection and try again." : (file ? "Upload failed. Use a file under 3 MB and set DEEPSEEK_API_KEY in Vercel. Try again." : thinkFallback(displayMsg));
          typingEl.classList.remove("typing");
          typingEl.querySelector("p").innerHTML = formatMsg(errMsg);
          requestAnimationFrame(function () { typingEl.scrollIntoView({ behavior: "auto", block: "end" }); });
        } finally {
          send.disabled = false;
          setTimeout(function () { if (input) input.focus(); }, 120);
        }
      });

      let history = [];

      // Restore chat from previous session
      try {
        const raw = localStorage.getItem("general_chat_history");
        if (raw) {
          const arr = JSON.parse(raw);
          if (Array.isArray(arr) && arr.length > 0) {
            history = arr;
            arr.forEach(function (m) {
              if (m && (m.role === "user" || m.role === "assistant")) {
                addMessage(m.role === "user" ? "user" : "ai", m.content || "");
              }
            });
          }
        }
      } catch (e) {}
      scheduleRenderHistory();

      var historyBtn = document.getElementById("history-btn");
      if (historyBtn && sidebar) historyBtn.addEventListener("click", function () {
        if (sidebar.classList.contains("open")) { closeSidebar(); return; }
        sidebar.classList.add("open");
        if (sidebarOverlay) { sidebarOverlay.classList.add("visible"); sidebarOverlay.setAttribute("aria-hidden", "false"); }
      });
      if (sidebarOverlay) sidebarOverlay.addEventListener("click", closeSidebar);

      var clearBtn = document.getElementById("clear-chat");
      if (clearBtn) clearBtn.addEventListener("click", function () {
        if (history.length > 0) {
          try {
            var archive = [];
            var raw = localStorage.getItem("general_chat_archive");
            if (raw) { var a = JSON.parse(raw); if (Array.isArray(a)) archive = a; }
            archive.push({ history: history.slice(0), createdAt: Date.now() });
            archive = archive.slice(-10);
            localStorage.setItem("general_chat_archive", JSON.stringify(archive));
          } catch (_) {}
        }
        history = [];
        try { localStorage.removeItem("general_chat_history"); } catch (_) {}
        var msgs = chat ? chat.querySelectorAll(".message") : [];
        for (var i = 1; i < msgs.length; i++) { try { msgs[i].remove(); } catch (_) {} }
        scheduleRenderHistory();
        closeSidebar();
      });

      if (input) input.focus();
    })();
  </script>
</body>
</html>
